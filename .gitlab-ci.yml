image: ruby:2.3.4

services:
   - mysql:5.7.19

variables:
   RAILS_ENV: "test"
   COVERAGE: "true"

before_script:
   - cp config/database-sample.yml config/database.yml
   - cp config/secrets-sample.yml config/secrets.yml
   - mkdir -p reports/
   - bundle install --jobs 4 --deployment

test:
   script:
      - bundle exec rake db:drop db:create db:migrate
      - bundle exec rake app:reports
   tags:
      - docker
   coverage: '/\(\d+.\d+\%\) covered/'
   artifacts:
      paths:
         - reports/
